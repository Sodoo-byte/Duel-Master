<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duel Master App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for password toggle icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            background-color: #1a202c; /* bg-gray-900 */
            color: #e2e8f0; /* text-gray-200 */
        }
        /* Custom styling for multi-select dropdown */
        .multi-select-dropdown {
            position: relative;
        }
        .multi-select-dropdown-options {
            position: absolute;
            background-color: #2d3748; /* gray-800 */
            border: 1px solid #4a5568; /* gray-600 */
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            z-index: 10;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
        }
        .multi-select-dropdown-option {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            color: #e2e8f0; /* text-gray-200 */
        }
        .multi-select-dropdown-option:hover {
            background-color: #4a5568; /* gray-600 */
        }
        /* Style for inputs in dark theme */
        input[type="text"],
        input[type="number"],
        input[type="password"],
        input[type="email"],
        input[type="tel"],
        select {
            background-color: #2d3748; /* gray-800 */
            color: #e2e8f0; /* text-gray-200 */
            border-color: #4a5568; /* gray-600 */
        }
        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="password"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        select:focus {
            border-color: #667eea; /* indigo-500 */
            box-shadow: 0 0 0 1px #667eea; /* ring-indigo-500 */
        }
        /* File input specific styling */
        input[type="file"]::file-selector-button {
            background-color: #667eea; /* violet-700 */
            color: #ffffff;
            border: 0;
            border-radius: 9999px; /* rounded-full */
            padding: 0.5rem 1rem;
            font-size: 0.875rem; /* text-sm */
            font-weight: 600; /* font-semibold */
            cursor: pointer;
            transition: background-color 0.15s ease-in-out;
        }
        input[type="file"]::file-selector-button:hover {
            background-color: #5a67d8; /* hover:violet-600 */
        }
        .password-input-container {
            position: relative;
        }
        .password-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #a0aec0; /* gray-400 */
        }
        .password-toggle:hover {
            color: #e2e8f0; /* gray-200 */
        }
        .frame-preview {
            width: 100px;
            height: 100px;
            border-radius: 9999px;
            object-fit: cover;
            object-position: center;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: #e2e8f0;
            background-color: #4a5568;
        }
        .frame-preview.border-frame {
            padding: 4px; /* Adjust padding for border frames */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 p-4 sm:p-6 lg:p-8">
    <header class="bg-gray-800 rounded-lg shadow-lg p-4 mb-6 text-center">
        <h1 class="text-4xl font-bold text-indigo-500">Duel Master App</h1>
        <p class="text-gray-400 mt-2">Manage players, challenge opponents, and bet on live duels!</p>
        <p class="text-sm text-gray-500 mt-1">Logged in as: <span id="loggedInUserIdDisplay" class="font-mono text-indigo-400 break-all">Not Logged In</span></p>
        <p class="text-lg font-semibold text-gray-300 mt-2">Your Balance: <span id="userBalanceDisplay" class="text-green-400"></span> â‚® | Your Coins: <span id="userCoinsDisplay" class="text-yellow-400"></span> ðŸª™</p>
    </header>

    <nav id="mainNav" class="bg-gray-800 rounded-lg shadow-lg p-2 mb-6 flex justify-center space-x-2 sm:space-x-4">
        <!-- Navigation buttons will be dynamically added/hidden based on login state -->
    </nav>

    <main id="appContent" class="container mx-auto">
        <!-- Content will be dynamically loaded here -->
    </main>

    <!-- Modal Structure (hidden by default) -->
    <div id="modalOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 max-w-lg w-full relative border border-gray-700">
            <h3 id="modalTitle" class="text-xl font-bold mb-4 text-gray-100"></h3>
            <button id="modalCloseBtn" class="absolute top-3 right-3 text-gray-400 hover:text-gray-200 text-2xl font-bold">
                &times;
            </button>
            <div id="modalContent" class="text-gray-300"></div>
        </div>
    </div>

    <script>
        // --- Global State and Utility Functions ---
        let players = JSON.parse(localStorage.getItem('duelMasterPlayers')) || [];
        let duelRequests = JSON.parse(localStorage.getItem('duelMasterRequests')) || [];
        let activeDuels = JSON.parse(localStorage.getItem('duelMasterActiveDuels')) || [];
        let bets = JSON.parse(localStorage.getItem('duelMasterBets')) || [];

        // User Accounts (for login)
        let userAccounts = JSON.parse(localStorage.getItem('duelMasterUserAccounts')) || [];
        let loggedInUserId = localStorage.getItem('duelMasterLoggedInUserId');
        let currentUserBalance = 0; // Will be updated on login
        let currentUserCoins = 0; // Will be updated on login
        let isCurrentUserAdmin = false; // Track admin status

        // Initialize admin accounts if they don't exist
        const initialAdminAccounts = [
            { id: 'Greed', password: '88912163', email: 'greed@admin.com', phone: '', balance: 100000000, isAdmin: true, coins: 1000 }, // Greed with 100M and 1000 coins
            { id: 'Pride', password: 'ErmuunAdmin', email: 'pride@admin.com', phone: '', balance: 1000000, isAdmin: true, coins: 100 },
            { id: 'Lust', password: 'BilguunAdmin', email: 'lust@admin.com', phone: '', balance: 1000000, isAdmin: true, coins: 100 },
        ];

        // Only add default admins if userAccounts is empty (first run)
        if (userAccounts.length === 0) {
            userAccounts = initialAdminAccounts;
            localStorage.setItem('duelMasterUserAccounts', JSON.stringify(userAccounts));
        } else {
            // Ensure existing users have 'coins', 'purchasedFrames', 'activeFrame' properties
            userAccounts = userAccounts.map(user => ({
                ...user,
                coins: user.coins !== undefined ? user.coins : 0,
                purchasedFrames: user.purchasedFrames !== undefined ? user.purchasedFrames : [],
                activeFrame: user.activeFrame !== undefined ? user.activeFrame : null
            }));
            localStorage.setItem('duelMasterUserAccounts', JSON.stringify(userAccounts));
        }

        // Ensure players have 'activeFrame' property
        players = players.map(player => ({
            ...player,
            activeFrame: player.activeFrame !== undefined ? player.activeFrame : null
        }));
        localStorage.setItem('duelMasterPlayers', JSON.stringify(players));


        // Special IDs management
        const SILVER_ID_COST = 50000;
        const GOLDEN_ID_COST = 100000;
        const SPECIAL_ID_COST = 300000;

        // Predefined "good looking lucky numbers" for Silver and Golden IDs
        // Silver IDs are 5 digits, displayed without leading zeros if they are numerically significant.
        // Stored as 5-digit strings for consistency in search/uniqueness.
        let silverIdsPool = [
            '00001', '00010', '00100', '00111', '00200', '00222', '00300', '00333', '00400', '00444', '00500', '00555',
            '01234', '04321', '12345', '54321', '10101', '20202', '30303', '40404', '50505', '60606', '70707', '80808', '90909',
            '11223', '33445', '55667', '77889', '99001', '12121', '23232', '34343', '45454', '56565', '67676', '78787', '89898', '90909',
            '11111', '22222', '33333', '44444', '55555', '66666', '77777', '88888', '99999'
        ];
        // Golden IDs are variable length, "soo good numbers"
        let goldenIdsPool = [
            '1', '7', '8', '9', '10', '11', '22', '33', '44', '55', '66', '77', '88', '99', '100',
            '111', '222', '333', '444', '555', '666', '777', '888', '999',
            '1000', '1111', '2222', '3333', '4444', '5555', '6666', '7777', '8888', '9999',
            '10000', '11111', '22222', '33333', '44444', '55555', '66666', '77777', '88888', '99999',
            '123456', '654321', '123123', '321321', '789789', '987987', '1234567', '7654321' // Adding some longer ones for variety
        ];

        let usedSpecialIds = new Set(JSON.parse(localStorage.getItem('duelMasterUsedSpecialIds')) || []);

        // Helper to check if an ID is already used by any player or user account (case-insensitive for user IDs)
        const isIdUsed = (id, isPlayerId = true) => {
            const lowerId = id.toLowerCase();
            if (isPlayerId) {
                if (players.some(p => p.id.toLowerCase() === lowerId)) return true;
            }
            if (userAccounts.some(u => u.id.toLowerCase() === lowerId)) return true;
            if (usedSpecialIds.has(id)) return true; // Special IDs are stored as they are, so check directly
            return false;
        };

        const getAvailableSilverIds = () => silverIdsPool.filter(id => !isIdUsed(id));
        const getAvailableGoldenIds = () => goldenIdsPool.filter(id => !isIdUsed(id));

        // Predefined game categories and their specific ranks
        const gameCategories = [
            'MÐ¾Ð½Ð³Ð¾Ð» Ð‘Ó©Ñ…', 'CS:GO', 'Mobile Legends: Bang Bang', 'Valorant', 'Dota 2',
            'League of Legends', 'Fortnite', 'Apex Legends', 'Overwatch 2', 'Tekken 8',
            'Street Fighter 6', 'FIFA 24', 'NBA 2K24', 'Chess', 'Poker'
        ];

        const gameRanksMap = {
            'MÐ¾Ð½Ð³Ð¾Ð» Ð‘Ó©Ñ…': ['ÐÐ°Ñ‡Ð¸Ð½', 'Ð—Ð°Ð°Ð½', 'Ð“Ð°Ñ€ÑƒÐ´Ð¸', 'ÐÑ€ÑÐ»Ð°Ð½', 'ÐÐ²Ð°Ñ€Ð³Ð°'],
            'CS:GO': ['Silver I', 'Silver II', 'Silver III', 'Silver IV', 'Silver Elite', 'Silver Elite Master',
                      'Gold Nova I', 'Gold Nova II', 'Gold Nova III', 'Gold Nova Master',
                      'Master Guardian I', 'Master Guardian II', 'Master Guardian Elite',
                      'Distinguished Master Guardian', 'Legendary Eagle', 'Legendary Eagle Master',
                      'Supreme Master First Class', 'Global Elite'],
            'Mobile Legends: Bang Bang': ['Warrior', 'Elite', 'Master', 'Grandmaster', 'Epic', 'Legend', 'Mythic'],
            // Default for other games will be a text input
        };

        let selectedDuel = null; // To hold the duel object when viewing stream

        const saveState = () => {
            localStorage.setItem('duelMasterPlayers', JSON.stringify(players));
            localStorage.setItem('duelMasterRequests', JSON.stringify(duelRequests));
            localStorage.setItem('duelMasterActiveDuels', JSON.stringify(activeDuels));
            localStorage.setItem('duelMasterBets', JSON.stringify(bets));
            localStorage.setItem('duelMasterUsedSpecialIds', JSON.stringify(Array.from(usedSpecialIds)));
            localStorage.setItem('duelMasterUserAccounts', JSON.stringify(userAccounts));
            localStorage.setItem('duelMasterLoggedInUserId', loggedInUserId || '');
        };

        // Generates a random 5-digit number for Normal ID
        const generateNormalId = () => {
            let id;
            do {
                id = Math.floor(10000 + Math.random() * 90000).toString(); // 10000 to 99999
            } while (isIdUsed(id)); // Ensure unique across players and user accounts
            return id;
        };

        // Generates a unique User ID (for new sign-ups when not logged in)
        const generateUniqueUserId = () => {
            let id;
            do {
                id = 'user-' + Math.random().toString(36).substring(2, 8); // e.g., "user-abc123"
            } while (isIdUsed(id, false)); // Check uniqueness only against existing user accounts
            return id;
        };

        // Generates a UUID for internal use where a truly unique string is needed
        const generateUniqueId = () => crypto.randomUUID();

        // --- Shop Data ---
        const COIN_VALUE = 1000; // 1 coin = 1000 Tugrug

        const shopItems = {
            coins: [
                { amount: 1, tugrugCost: 1 * COIN_VALUE },
                { amount: 10, tugrugCost: 10 * COIN_VALUE },
                { amount: 100, tugrugCost: 100 * COIN_VALUE },
                { amount: 1000, tugrugCost: 1000 * COIN_VALUE }
            ],
            profileFrames: [
                { id: 'frame-basic-silver', name: 'Basic Silver', cost: 1, type: 'border', value: 'border-2 border-gray-400' },
                { id: 'frame-golden-glow', name: 'Golden Glow', cost: 3, type: 'border', value: 'border-2 border-yellow-500 shadow-lg shadow-yellow-500/50' },
                { id: 'frame-diamond-edge', name: 'Diamond Edge', cost: 5, type: 'border', value: 'border-2 border-blue-500 shadow-lg shadow-blue-500/50' },
                { id: 'frame-fiery-aura', name: 'Fiery Aura', cost: 7, type: 'custom-class', value: 'bg-gradient-to-br from-red-500 to-orange-500 text-transparent bg-clip-text' },
                { id: 'frame-neon-circuit', name: 'Neon Circuit', cost: 9, type: 'custom-class', value: 'border-2 border-purple-400 shadow-lg shadow-purple-400/50 animate-pulse' },
                { id: 'frame-royal-crest', name: 'Royal Crest', cost: 10, type: 'custom-class', value: 'border-4 border-yellow-700 shadow-xl shadow-yellow-700/70' }
            ],
            playerIDChangeCost: 50 // Cost in coins to change a player's ID
        };


        // --- Modal Functions ---
        const showModal = (title, message) => {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalContent').textContent = message;
            document.getElementById('modalOverlay').classList.remove('hidden');
        };

        const hideModal = () => {
            document.getElementById('modalOverlay').classList.add('hidden');
        };

        // --- Password Toggle Function ---
        const setupPasswordToggle = (inputId) => {
            const input = document.getElementById(inputId);
            const toggleIcon = document.getElementById(`${inputId}Toggle`);
            if (input && toggleIcon) {
                toggleIcon.addEventListener('click', () => {
                    if (input.type === 'password') {
                        input.type = 'text';
                        toggleIcon.classList.remove('fa-eye');
                        toggleIcon.classList.add('fa-eye-slash');
                    } else {
                        input.type = 'password';
                        toggleIcon.classList.remove('fa-eye-slash');
                        toggleIcon.classList.add('fa-eye');
                    }
                });
            }
        };

        // --- Login/Logout & User Management ---
        const loginUser = (id, password) => {
            const user = userAccounts.find(acc => acc.id.toLowerCase() === id.toLowerCase() && acc.password === password);
            if (user) {
                loggedInUserId = user.id; // Store the actual ID from the userAccounts array
                currentUserBalance = user.balance;
                currentUserCoins = user.coins;
                isCurrentUserAdmin = user.isAdmin || false; // Set admin status
                saveState();
                showModal('Login Successful', `Welcome, ${loggedInUserId}! Your balance: ${currentUserBalance.toLocaleString()} â‚®. Your coins: ${currentUserCoins.toLocaleString()} ðŸª™`);
                console.log('Logged in user:', user); // For debugging admin access
                renderMainAppContent(); // Show main app after login
            } else {
                showModal('Login Failed', 'Invalid ID or password.');
            }
        };

        const logoutUser = () => {
            loggedInUserId = null;
            currentUserBalance = 0;
            currentUserCoins = 0;
            isCurrentUserAdmin = false;
            saveState();
            showModal('Logged Out', 'You have been logged out.');
            renderLogin(); // Show login screen
        };

        const updateBalanceDisplay = () => {
            const user = userAccounts.find(acc => acc.id === loggedInUserId);
            if (user) {
                currentUserBalance = user.balance;
                currentUserCoins = user.coins;
                document.getElementById('userBalanceDisplay').textContent = currentUserBalance.toLocaleString() + ' â‚®';
                document.getElementById('userCoinsDisplay').textContent = currentUserCoins.toLocaleString() + ' ðŸª™';
            } else {
                document.getElementById('userBalanceDisplay').textContent = 'N/A';
                document.getElementById('userCoinsDisplay').textContent = 'N/A';
            }
        };

        // --- Tab Management ---
        const appContentDiv = document.getElementById('appContent');
        const mainNav = document.getElementById('mainNav');

        const renderNavButtons = () => {
            mainNav.innerHTML = ''; // Clear existing buttons
            if (loggedInUserId) {
                if (isCurrentUserAdmin) {
                    mainNav.innerHTML += `
                        <button id="registerPlayerTabBtn" class="px-4 py-2 rounded-md font-medium transition duration-150 ease-in-out bg-indigo-600 text-white shadow-md hover:bg-indigo-700">
                            Register Player
                        </button>
                    `;
                    document.getElementById('registerPlayerTabBtn').addEventListener('click', () => activateTab('registerPlayer'));
                }
                mainNav.innerHTML += `
                    <button id="playersTabBtn" class="px-4 py-2 rounded-md font-medium transition duration-150 ease-in-out bg-gray-700 text-gray-300 hover:bg-gray-600">
                        Player List
                    </button>
                    <button id="requestsTabBtn" class="px-4 py-2 rounded-md font-medium transition duration-150 ease-in-out bg-gray-700 text-gray-300 hover:bg-gray-600">
                        Duel Requests
                    </button>
                    <button id="duelsTabBtn" class="px-4 py-2 rounded-md font-medium transition duration-150 ease-in-out bg-gray-700 text-gray-300 hover:bg-gray-600">
                        Active Duels
                    </button>
                    <button id="shopTabBtn" class="px-4 py-2 rounded-md font-medium transition duration-150 ease-in-out bg-yellow-600 text-white shadow-md hover:bg-yellow-700">
                        Shop
                    </button>
                    <button id="logoutBtn" class="px-4 py-2 rounded-md font-medium transition duration-150 ease-in-out bg-red-600 text-white shadow-md hover:bg-red-700">
                        Logout (${loggedInUserId})
                    </button>
                `;
                document.getElementById('playersTabBtn').addEventListener('click', () => activateTab('players'));
                document.getElementById('requestsTabBtn').addEventListener('click', () => activateTab('requests'));
                document.getElementById('duelsTabBtn').addEventListener('click', () => activateTab('duels'));
                document.getElementById('shopTabBtn').addEventListener('click', () => activateTab('shop'));
                document.getElementById('logoutBtn').addEventListener('click', logoutUser);
            }
            console.log('Is current user admin (renderNavButtons)?', isCurrentUserAdmin); // For debugging
        };

        const activateTab = (tabName) => {
            // Reset selected duel when changing tabs
            selectedDuel = null;
            renderContent(tabName);

            // Update active button styling
            const buttons = mainNav.querySelectorAll('button');
            buttons.forEach(button => {
                if (button.id.includes(tabName)) {
                    button.classList.remove('bg-gray-700', 'text-gray-300', 'hover:bg-gray-600', 'bg-yellow-600', 'hover:bg-yellow-700');
                    button.classList.add('bg-indigo-600', 'text-white', 'shadow-md');
                } else if (button.id === 'shopTabBtn') {
                    button.classList.remove('bg-indigo-600', 'text-white', 'shadow-md');
                    button.classList.add('bg-yellow-600', 'text-white', 'shadow-md', 'hover:bg-yellow-700');
                }
                else if (button.id !== 'logoutBtn') { // Don't change logout button style
                    button.classList.remove('bg-indigo-600', 'text-white', 'shadow-md', 'bg-yellow-600', 'hover:bg-yellow-700');
                    button.classList.add('bg-gray-700', 'text-gray-300', 'hover:bg-gray-600');
                }
            });
        };

        // --- Render Login Screen ---
        const renderLogin = () => {
            appContentDiv.innerHTML = `
                <div class="bg-gray-800 p-8 rounded-lg shadow-lg w-full max-w-md mx-auto border border-gray-700">
                    <h2 class="text-3xl font-bold text-gray-100 mb-6 text-center">Login</h2>
                    <form id="loginForm" class="space-y-5">
                        <div>
                            <label for="loginId" class="block text-sm font-medium text-gray-300">User ID</label>
                            <input type="text" id="loginId" class="mt-1 block w-full px-4 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                        </div>
                        <div class="password-input-container">
                            <label for="loginPassword" class="block text-sm font-medium text-gray-300">Password</label>
                            <input type="password" id="loginPassword" class="mt-1 block w-full px-4 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                            <i class="fas fa-eye password-toggle" id="loginPasswordToggle"></i>
                        </div>
                        <button type="submit" class="w-full py-2.5 px-4 border border-transparent rounded-md shadow-sm text-lg font-semibold text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                            Login
                        </button>
                    </form>
                    <p class="mt-6 text-center text-gray-400">
                        Don't have an account? <button id="switchToRegisterPlayerBtn" class="text-indigo-400 hover:text-indigo-300 font-medium">Sign Up & Create Player Profile</button>
                    </p>
                    <p class="mt-2 text-center text-gray-500 text-sm">
                        Forgot password? (Contact admin for recovery)
                    </p>
                </div>
            `;
            document.getElementById('loggedInUserIdDisplay').textContent = 'Not Logged In';
            document.getElementById('userBalanceDisplay').textContent = 'N/A';
            document.getElementById('userCoinsDisplay').textContent = 'N/A';

            document.getElementById('loginForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const id = document.getElementById('loginId').value;
                const password = document.getElementById('loginPassword').value;
                loginUser(id, password);
            });

            document.getElementById('switchToRegisterPlayerBtn').addEventListener('click', () => renderContent('registerPlayer'));
            setupPasswordToggle('loginPassword');
            renderNavButtons(); // Clear nav buttons when not logged in
        };

        // --- Render Main App Content (after login) ---
        const renderMainAppContent = () => {
            const user = userAccounts.find(acc => acc.id === loggedInUserId);
            document.getElementById('loggedInUserIdDisplay').textContent = user ? user.id.toUpperCase() : 'Not Logged In'; // Admin IDs always uppercase
            updateBalanceDisplay();
            renderNavButtons(); // Show nav buttons after login
            activateTab('players'); // Default to player list tab after login
        };

        // --- Render Register Player (now handles both new user and new player for existing user) ---
        const renderRegisterPlayer = () => {
            const availableSilver = getAvailableSilverIds();
            const availableGolden = getAvailableGoldenIds();

            let silverIdOptionsHtml = availableSilver.map(id => `<option value="${id}">${parseInt(id)}</option>`).join(''); // Display without leading zeros
            if (availableSilver.length === 0) {
                silverIdOptionsHtml = '<option value="" disabled>No Silver IDs available</option>';
            }

            let goldenIdOptionsHtml = availableGolden.map(id => `<option value="${id}">${id}</option>`).join('');
            if (availableGolden.length === 0) {
                goldenIdOptionsHtml = '<option value="" disabled>No Golden IDs available</option>';
            }

            const gameOptionsHtml = gameCategories.map(game => `
                <label class="multi-select-dropdown-option">
                    <input type="checkbox" value="${game}" class="form-checkbox text-indigo-600 rounded-sm register-game-checkbox">
                    <span class="ml-2">${game}</span>
                </label>
            `).join('');

            const isUserLoggedIn = loggedInUserId !== null;
            const isCreatingNewUserAccount = !isUserLoggedIn || isCurrentUserAdmin; // True if guest or admin

            const playerProfileSection = `
                <fieldset class="border border-gray-700 p-4 rounded-md space-y-4">
                    <legend class="text-lg font-semibold text-gray-200 px-2">Player Profile Details</legend>
                    <div>
                        <label for="playerName" class="block text-sm font-medium text-gray-300">Player Name</label>
                        <input type="text" id="playerName" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div>
                        <label for="photoUpload" class="block text-sm font-medium text-gray-300">Player Photo</label>
                        <input type="file" id="photoUpload" accept="image/*" class="mt-1 block w-full text-sm text-gray-400">
                        <img id="photoPreview" src="https://placehold.co/100x100/AEC6CF/FFFFFF?text=Preview" alt="Photo Preview" class="mt-2 w-24 h-24 rounded-full object-cover object-center border border-gray-600" />
                        <p id="photoError" class="text-red-400 text-xs mt-1 hidden"></p>
                    </div>
                    <div>
                        <label for="age" class="block text-sm font-medium text-gray-300">Age</label>
                        <input type="number" id="age" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div>
                        <label for="weight" class="block text-sm font-medium text-gray-300">Weight (kg)</label>
                        <input type="number" id="weight" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                   
                    <div>
                        <label class="block text-sm font-medium text-gray-300">Games Played</label>
                        <div class="multi-select-dropdown mt-1">
                            <button type="button" id="gamesSelectBtn" class="w-full px-3 py-2 border border-gray-600 rounded-md shadow-sm bg-gray-700 text-left focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-gray-300">
                                Select Games
                            </button>
                            <div id="gamesOptions" class="multi-select-dropdown-options hidden">
                                ${gameOptionsHtml}
                            </div>
                        </div>
                        <div id="selectedGamesDisplay" class="mt-2 text-sm text-gray-400"></div>
                        <div id="gameRanksInputContainer" class="mt-4 space-y-3 p-3 border border-gray-700 rounded-md bg-gray-700">
                            <!-- Dynamic rank inputs will be inserted here -->
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-300">Player ID Type</label>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                            <label class="inline-flex items-center p-2 border border-gray-600 rounded-md cursor-pointer hover:bg-gray-700">
                                <input type="radio" name="idType" value="normal" checked class="form-radio text-indigo-500" id="normalIdRadio">
                                <span class="ml-2 text-gray-300">Normal ID (Free)</span>
                            </label>
                            <label class="inline-flex items-center p-2 border border-gray-600 rounded-md cursor-pointer hover:bg-gray-700 ${availableSilver.length === 0 || (isUserLoggedIn ? currentUserBalance : 0) < SILVER_ID_COST ? 'opacity-50 cursor-not-allowed' : ''}">
                                <input type="radio" name="idType" value="silver" class="form-radio text-indigo-500" id="silverIdRadio" ${availableSilver.length === 0 || (isUserLoggedIn ? currentUserBalance : 0) < SILVER_ID_COST ? 'disabled' : ''}>
                                <span class="ml-2 text-gray-300">Silver ID (${SILVER_ID_COST.toLocaleString()} â‚®)</span>
                            </label>
                            <label class="inline-flex items-center p-2 border border-gray-600 rounded-md cursor-pointer hover:bg-gray-700 ${availableGolden.length === 0 || (isUserLoggedIn ? currentUserBalance : 0) < GOLDEN_ID_COST ? 'opacity-50 cursor-not-allowed' : ''}">
                                <input type="radio" name="idType" value="golden" class="form-radio text-indigo-500" id="goldenIdRadio" ${availableGolden.length === 0 || (isUserLoggedIn ? currentUserBalance : 0) < GOLDEN_ID_COST ? 'disabled' : ''}>
                                <span class="ml-2 text-gray-300">Golden ID (${GOLDEN_ID_COST.toLocaleString()} â‚®)</span>
                            </label>
                            <label class="inline-flex items-center p-2 border border-gray-600 rounded-md cursor-pointer hover:bg-gray-700 ${ (isUserLoggedIn ? currentUserBalance : 0) < SPECIAL_ID_COST ? 'opacity-50 cursor-not-allowed' : ''}">
                                <input type="radio" name="idType" value="special" class="form-radio text-indigo-500" id="specialIdRadio" ${ (isUserLoggedIn ? currentUserBalance : 0) < SPECIAL_ID_COST ? 'disabled' : ''}>
                                <span class="ml-2 text-gray-300">Special ID (${SPECIAL_ID_COST.toLocaleString()} â‚®)</span>
                            </label>
                        </div>

                        <div id="silverIdSelection" class="mt-2 hidden">
                            <label for="silverId" class="block text-sm font-medium text-gray-300">Select Silver ID</label>
                            <select id="silverId" class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">-- Select --</option>
                                ${silverIdOptionsHtml}
                            </select>
                        </div>
                        <div id="goldenIdSelection" class="mt-2 hidden">
                            <label for="goldenId" class="block text-sm font-medium text-gray-300">Select Golden ID</label>
                            <select id="goldenId" class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">-- Select --</option>
                                ${goldenIdOptionsHtml}
                            </select>
                        </div>
                        <div id="specialIdInput" class="mt-2 hidden">
                            <label for="customSpecialId" class="block text-sm font-medium text-gray-300">Enter Custom Special ID (No numbers, 3+ chars)</label>
                            <input type="text" id="customSpecialId" placeholder="e.g., MYDUELID" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                </fieldset>
            `;

            let accountDetailsSection = '';
            // Account details section is always present if creating a new user account (guest or admin)
            if (isCreatingNewUserAccount) {
                accountDetailsSection = `
                    <fieldset class="border border-gray-700 p-4 rounded-md space-y-4">
                        <legend class="text-lg font-semibold text-gray-200 px-2">Account Details</legend>
                        ${isCurrentUserAdmin ? `
                            <div>
                                <label for="registerUserId" class="block text-sm font-medium text-gray-300">New User ID (for admin-created account)</label>
                                <input type="text" id="registerUserId" class="mt-1 block w-full px-4 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                                <p id="registerUserIdError" class="text-red-400 text-xs mt-1 hidden">User ID must be unique.</p>
                            </div>
                        ` : ''}
                        <div class="password-input-container">
                            <label for="registerPassword" class="block text-sm font-medium text-gray-300">Password</label>
                            <input type="password" id="registerPassword" class="mt-1 block w-full px-4 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                            <i class="fas fa-eye password-toggle" id="registerPasswordToggle"></i>
                            <p id="passwordStrength" class="text-xs mt-1 text-gray-400">Password must be at least 8 characters long, contain uppercase, lowercase, number, and special character.</p>
                        </div>
                        <div class="password-input-container">
                            <label for="confirmPassword" class="block text-sm font-medium text-gray-300">Confirm Password</label>
                            <input type="password" id="confirmPassword" class="mt-1 block w-full px-4 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                            <i class="fas fa-eye password-toggle" id="confirmPasswordToggle"></i>
                            <p id="confirmPasswordError" class="text-red-400 text-xs mt-1 hidden">Passwords do not match.</p>
                        </div>
                    </fieldset>
                `;
            }

            let contactInfoSection = '';
            // Contact info section is always present if creating a new user account (guest or admin)
            if (isCreatingNewUserAccount) {
                contactInfoSection = `
                    <fieldset class="border border-gray-700 p-4 rounded-md space-y-4">
                        <legend class="text-lg font-semibold text-gray-200 px-2">Contact Information (for recovery)</legend>
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-300">Email (Optional)</label>
                            <input type="email" id="email" class="mt-1 block w-full px-4 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="phone" class="block text-sm font-medium text-gray-300">Phone Number (Optional)</label>
                            <input type="tel" id="phone" class="mt-1 block w-full px-4 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <p id="contactError" class="text-red-400 text-xs mt-1 hidden">Please provide either an email or a phone number.</p>
                        </div>
                    </fieldset>
                `;
            }

            appContentDiv.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-6 w-full max-w-md mx-auto border border-gray-700">
                    <h2 class="text-2xl font-bold text-gray-100 mb-4">${isUserLoggedIn ? 'Register New Player' : 'Sign Up & Create Player Profile'}</h2>
                    <form id="registrationForm" class="space-y-4">
                        ${playerProfileSection}
                        ${accountDetailsSection}
                        ${contactInfoSection}

                        <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                            ${isUserLoggedIn ? 'Register New Player' : 'Sign Up & Create Player'}
                        </button>
                    </form>
                    ${!isUserLoggedIn ? `
                    <p class="mt-6 text-center text-gray-400">
                        Already have an account? <button id="switchToLoginBtn" class="text-indigo-400 hover:text-indigo-300 font-medium">Login here</button>
                    </p>
                    ` : ''}
                </div>
            `;

            const registrationForm = document.getElementById('registrationForm');
            // These might be null if not admin and not creating new user account
            const registerUserIdInput = document.getElementById('registerUserId');
            const registerUserIdError = document.getElementById('registerUserIdError');

            const registerPasswordInput = document.getElementById('registerPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const confirmPasswordError = document.getElementById('confirmPasswordError');
            const passwordStrength = document.getElementById('passwordStrength');
            const emailInput = document.getElementById('email');
            const phoneInput = document.getElementById('phone');
            const contactError = document.getElementById('contactError');

            const playerNameInput = document.getElementById('playerName');
            const photoUpload = document.getElementById('photoUpload');
            const photoPreview = document.getElementById('photoPreview');
            const photoError = document.getElementById('photoError');
            const ageInput = document.getElementById('age');
            const weightInput = document.getElementById('weight');
            const idTypeRadios = document.querySelectorAll('input[name="idType"]');
            const silverIdSelectionDiv = document.getElementById('silverIdSelection');
            const goldenIdSelectionDiv = document.getElementById('goldenIdSelection');
            const specialIdInputDiv = document.getElementById('specialIdInput');
            const silverIdSelect = document.getElementById('silverId');
            const goldenIdSelect = document.getElementById('goldenId');
            const customSpecialIdInput = document.getElementById('customSpecialId');

            const gamesSelectBtn = document.getElementById('gamesSelectBtn');
            const gamesOptionsDiv = document.getElementById('gamesOptions');
            const registerGameCheckboxes = gamesOptionsDiv.querySelectorAll('.register-game-checkbox');
            const selectedGamesDisplay = document.getElementById('selectedGamesDisplay');
            const gameRanksInputContainer = document.getElementById('gameRanksInputContainer');

            let uploadedPhotoDataUrl = ''; // To store the Data URL of the uploaded image
            let selectedGames = []; // Stores only game names
            let gameSpecificRanks = {}; // Stores { 'Game Name': 'Rank Value' }

            // Setup password toggles for this form
            if (registerPasswordInput) {
                setupPasswordToggle('registerPassword');
            }
            if (confirmPasswordInput) {
                setupPasswordToggle('confirmPassword');
            }

            const updateSelectedGamesDisplay = () => {
                selectedGamesDisplay.textContent = selectedGames.length > 0 ? selectedGames.join(', ') : 'No games selected';
                gamesSelectBtn.textContent = selectedGames.length > 0 ? `Selected (${selectedGames.length})` : 'Select Games';
            };

            const renderGameRankInputs = () => {
                gameRanksInputContainer.innerHTML = ''; // Clear previous inputs
                const currentRanks = { ...gameSpecificRanks };
                gameSpecificRanks = {}; // Reset for selected games

                if (selectedGames.length > 0) {
                    const title = document.createElement('h4');
                    title.className = 'text-md font-semibold text-gray-300 mb-2';
                    title.textContent = 'Enter Ranks for Selected Games:';
                    gameRanksInputContainer.appendChild(title);
                }

                selectedGames.forEach(game => {
                    const gameRankType = gameRanksMap[game];
                    let inputHtml = '';
                    const existingRank = currentRanks[game] || '';

                    if (gameRankType && Array.isArray(gameRankType)) {
                        const optionsHtml = gameRankType.map(rank =>
                            `<option value="${rank}" ${existingRank === rank ? 'selected' : ''}>${rank}</option>`
                        ).join('');
                        inputHtml = `
                            <label for="rank-${game.replace(/\s/g, '-')}" class="block text-sm font-medium text-gray-300">${game} Rank</label>
                            <select id="rank-${game.replace(/\s/g, '-')}" data-game="${game}" class="game-rank-input mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">-- Select Rank --</option>
                                ${optionsHtml}
                            </select>
                        `;
                    } else {
                        inputHtml = `
                            <label for="rank-${game.replace(/\s/g, '-')}" class="block text-sm font-medium text-gray-300">${game} Rank</label>
                            <input type="text" id="rank-${game.replace(/\s/g, '-')}" data-game="${game}" placeholder="Enter rank for ${game}" value="${existingRank}" class="game-rank-input mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        `;
                    }

                    const div = document.createElement('div');
                    div.innerHTML = inputHtml;
                    gameRanksInputContainer.appendChild(div);

                    gameSpecificRanks[game] = existingRank; // Re-populate with existing or default empty

                    const inputElement = document.getElementById(`rank-${game.replace(/\s/g, '-')}`);
                    if (inputElement) {
                        inputElement.addEventListener('input', (e) => {
                            gameSpecificRanks[game] = e.target.value;
                        });
                        inputElement.addEventListener('change', (e) => {
                            gameSpecificRanks[game] = e.target.value;
                        });
                    }
                });
            };

            gamesSelectBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                gamesOptionsDiv.classList.toggle('hidden');
            });

            registerGameCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    selectedGames = Array.from(registerGameCheckboxes)
                        .filter(cb => cb.checked)
                        .map(cb => cb.value);
                    updateSelectedGamesDisplay();
                    renderGameRankInputs();
                });
            });

            document.addEventListener('click', (e) => {
                if (!gamesOptionsDiv.contains(e.target) && e.target !== gamesSelectBtn) {
                    gamesOptionsDiv.classList.add('hidden');
                }
            });

            photoUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        uploadedPhotoDataUrl = event.target.result;
                        photoPreview.src = uploadedPhotoDataUrl;
                        try {
                            localStorage.setItem('test_image_size', uploadedPhotoDataUrl);
                            localStorage.removeItem('test_image_size');
                            photoError.classList.add('hidden');
                        } catch (e) {
                            photoError.textContent = 'Warning: Image is very large and might not persist across sessions due to browser storage limits.';
                            photoError.classList.remove('hidden');
                        }
                    };
                    reader.readAsDataURL(file);
                } else {
                    uploadedPhotoDataUrl = '';
                    photoPreview.src = `https://placehold.co/100x100/AEC6CF/FFFFFF?text=Preview`;
                    photoError.classList.add('hidden');
                }
            });

            const toggleIdTypeVisibility = () => {
                silverIdSelectionDiv.classList.add('hidden');
                goldenIdSelectionDiv.classList.add('hidden');
                specialIdInputDiv.classList.add('hidden');

                const selectedIdType = document.querySelector('input[name="idType"]:checked').value;
                if (selectedIdType === 'silver') {
                    silverIdSelectionDiv.classList.remove('hidden');
                } else if (selectedIdType === 'golden') {
                    goldenIdSelectionDiv.classList.remove('hidden');
                } else if (selectedIdType === 'special') {
                    specialIdInputDiv.classList.remove('hidden');
                }
            };

            idTypeRadios.forEach(radio => radio.addEventListener('change', toggleIdTypeVisibility));
            toggleIdTypeVisibility();

            const validatePasswordInput = () => {
                if (registerPasswordInput) { // Only validate if password input is present
                    const pass = registerPasswordInput.value;
                    let strength = 0;
                    if (pass.length >= 8) strength++;
                    if (/[a-z]/.test(pass)) strength++;
                    if (/[A-Z]/.test(pass)) strength++;
                    if (/\d/.test(pass)) strength++;
                    if (/[^a-zA-Z0-9]/.test(pass)) strength++;

                    let msg = 'Password must be at least 8 characters long, contain uppercase, lowercase, number, and special character.';
                    let color = 'text-red-400';

                    if (strength === 5) { msg = 'Strong password!'; color = 'text-green-400'; }
                    else if (strength >= 3) { msg = 'Medium password.'; color = 'text-yellow-400'; }
                    else { msg = 'Weak password.'; color = 'text-red-400'; }

                    passwordStrength.textContent = msg;
                    passwordStrength.className = `text-xs mt-1 ${color}`;
                }
            };

            if (registerPasswordInput) { // Only add listener if element exists
                registerPasswordInput.addEventListener('input', validatePasswordInput);
            }
            if (confirmPasswordInput) { // Only add listener if element exists
                confirmPasswordInput.addEventListener('input', () => {
                    if (registerPasswordInput.value !== confirmPasswordInput.value) {
                        confirmPasswordError.classList.remove('hidden');
                    } else {
                        confirmPasswordError.classList.add('hidden');
                    }
                });
            }

            if (!isUserLoggedIn) {
                document.getElementById('switchToLoginBtn').addEventListener('click', renderLogin);
            }


            registrationForm.addEventListener('submit', (e) => {
                e.preventDefault();

                let currentUserIdForPlayer = loggedInUserId; // Default to logged-in user if already logged in
                let playerCost = 0; // Cost for player ID
                let newAccountCreated = false;
                let newGeneratedUserId = null; // To store auto-generated ID for display

                // --- Account Validation (if new user or admin creating new user) ---
                if (isCreatingNewUserAccount) { // This variable is true if guest OR admin
                    const password = registerPasswordInput.value;
                    const confirmPassword = confirmPasswordInput.value;
                    const email = emailInput.value.trim();
                    const phone = phoneInput.value.trim();

                    // Password validation
                    if (!password) {
                        showModal('Registration Error', 'Password is required.');
                        return;
                    }
                    if (password !== confirmPassword) {
                        showModal('Registration Error', 'Passwords do not match.');
                        return;
                    }
                    if (password.length < 8 || !/[a-z]/.test(password) || !/[A-Z]/.test(password) || !/\d/.test(password) || !/[^a-zA-Z0-9]/.test(password)) {
                         showModal('Registration Error', 'Password must be at least 8 characters long and contain uppercase, lowercase, number, and special character.');
                         return;
                    }

                    // Contact info validation
                    if (!email && !phone) {
                        contactError.classList.remove('hidden');
                        return;
                    } else {
                        contactError.classList.add('hidden');
                    }

                    if (!isUserLoggedIn) {
                        // Guest signing up: User ID is auto-generated
                        newGeneratedUserId = generateUniqueUserId();
                        currentUserIdForPlayer = newGeneratedUserId;
                    } else if (isCurrentUserAdmin) {
                        // Admin creating new user: User ID is provided by admin
                        const userId = registerUserIdInput.value.trim();
                        if (!userId) {
                            showModal('Registration Error', 'New User ID is required.');
                            return;
                        }
                        if (isIdUsed(userId, false)) { // Check if User ID is unique (pass false for isPlayerId to check only userAccounts and special IDs)
                            showModal('Registration Error', 'This User ID is already taken. Please choose another.');
                            return;
                        }
                        currentUserIdForPlayer = userId;
                    }
                    newAccountCreated = true;
                }

                // --- Player Profile Validation ---
                const playerName = playerNameInput.value;
                const age = ageInput.value;
                const weight = weightInput.value;
                const idType = document.querySelector('input[name="idType"]:checked').value;
                let playerId;

                if (!playerName || !age || !weight) {
                    showModal('Registration Error', 'All player profile fields (Name, Age, Weight) are required.');
                    return;
                }
                if (selectedGames.length === 0) {
                    showModal('Registration Error', 'Please select at least one game played for your player profile.');
                    return;
                }

                const playerGamesWithRanks = [];
                for (const game of selectedGames) {
                    const gameRank = gameSpecificRanks[game] || '';
                    if (!gameRank.trim()) {
                        showModal('Registration Error', `Please enter a rank for "${game}" in your player profile.`);
                        return;
                    }
                    playerGamesWithRanks.push({ name: game, rank: gameRank.trim() });
                }

                // Determine Player ID and its cost
                if (idType === 'normal') {
                    playerId = generateNormalId();
                    playerCost = 0;
                } else if (idType === 'silver') {
                    const selectedSilverId = silverIdSelect.value;
                    if (!selectedSilverId) {
                        showModal('Registration Error', 'Please select a Silver ID for your player profile.');
                        return;
                    }
                    if (isIdUsed(selectedSilverId, true)) { // Check if Player ID is unique
                        showModal('Registration Error', 'Selected Silver ID is already taken. Please choose another.');
                        return;
                    }
                    playerId = selectedSilverId;
                    playerCost = SILVER_ID_COST;
                } else if (idType === 'golden') {
                    const selectedGoldenId = goldenIdSelect.value;
                    if (!selectedGoldenId) {
                        showModal('Registration Error', 'Please select a Golden ID for your player profile.');
                        return;
                    }
                    if (isIdUsed(selectedGoldenId, true)) { // Check if Player ID is unique
                        showModal('Registration Error', 'Selected Golden ID is already taken. Please choose another.');
                        return;
                    }
                    playerId = selectedGoldenId;
                    playerCost = GOLDEN_ID_COST;
                } else if (idType === 'special') {
                    const customId = customSpecialIdInput.value.trim();
                    if (!customId) {
                        showModal('Registration Error', 'Please enter a custom Special ID for your player profile.');
                        return;
                    }
                    if (customId.length < 3) { // Special ID min length validation
                        showModal('Registration Error', 'Special ID must be at least 3 characters long.');
                        return;
                    }
                    if (/\d/.test(customId)) {
                        showModal('Registration Error', 'Special ID cannot contain numbers. Please use only letters, hyphens, or other non-numeric characters.');
                        return;
                    }
                    if (isIdUsed(customId, true)) { // Check if Player ID is unique
                        showModal('Registration Error', 'This custom Special ID is already taken. Please choose another.');
                        return;
                    }
                    playerId = customId;
                    playerCost = SPECIAL_ID_COST;
                }

                // Determine effective balance for cost check
                // New users now start with 0 balance, existing users use their current balance
                let balanceForCheck = isUserLoggedIn ? currentUserBalance : 0;

                if (playerCost > 0 && balanceForCheck < playerCost) {
                    showModal('Payment Error', `Insufficient balance. You need ${playerCost.toLocaleString()} â‚® but have ${balanceForCheck.toLocaleString()} â‚®.`);
                    return;
                }

                // Handle balance deduction and user account creation/update
                let finalUserBalance = balanceForCheck - playerCost;

                if (newAccountCreated) {
                    // This is a new user account being created (either by guest or admin)
                    const newUserAccount = {
                        id: currentUserIdForPlayer,
                        password: registerPasswordInput.value,
                        email: emailInput.value.trim(),
                        phone: phoneInput.value.trim(),
                        balance: finalUserBalance, // This will be 0 or negative based on playerCost
                        coins: 0, // New users start with 0 coins
                        isAdmin: isCurrentUserAdmin, // If admin is creating, it's a regular user unless specified otherwise (not in this scope)
                        purchasedFrames: [],
                        activeFrame: null
                    };
                    userAccounts.push(newUserAccount);
                    loggedInUserId = newUserAccount.id; // Auto-login the newly created user
                    currentUserBalance = newUserAccount.balance;
                    currentUserCoins = newUserAccount.coins;
                    isCurrentUserAdmin = newUserAccount.isAdmin; // Update admin status for the newly logged in user
                } else {
                    // User is already logged in (and not admin creating a new user account), registering another player
                    const loggedInAccount = userAccounts.find(acc => acc.id === loggedInUserId);
                    if (loggedInAccount) {
                        loggedInAccount.balance -= playerCost;
                        currentUserBalance = loggedInAccount.balance;
                    }
                    finalUserBalance = currentUserBalance; // Update for display
                }

                // Mark ID as used if it's a special ID
                if (idType !== 'normal') {
                    usedSpecialIds.add(playerId);
                }

                const finalPhotoUrl = uploadedPhotoDataUrl || `https://placehold.co/100x100/AEC6CF/FFFFFF?text=${playerName.charAt(0)}`;

                const newPlayer = {
                    id: playerId,
                    name: playerName,
                    age: parseInt(age),
                    weight: parseInt(weight),
                    photoUrl: finalPhotoUrl,
                    status: 'available',
                    registeredBy: currentUserIdForPlayer, // Link to the user account
                    games: playerGamesWithRanks,
                    idType: idType, // Store ID type for display formatting
                    activeFrame: null // New players start with no active frame
                };
                players.push(newPlayer);

                saveState();
                let registrationMessage = `Player "${playerName}" registered successfully with ID "${playerId}"! Cost: ${playerCost.toLocaleString()} â‚®. Your new balance: ${finalUserBalance.toLocaleString()} â‚®.`;
                if (newGeneratedUserId) {
                    registrationMessage += ` Your new User ID is: ${newGeneratedUserId}. Please remember it for future logins.`;
                }
                showModal('Registration Status', registrationMessage);

                // Clear form and reset photo preview
                registrationForm.reset();
                uploadedPhotoDataUrl = '';
                photoPreview.src = `https://placehold.co/100x100/AEC6CF/FFFFFF?text=Preview`;
                photoError.classList.add('hidden');
                selectedGames = [];
                gameSpecificRanks = {};
                updateSelectedGamesDisplay();
                renderGameRankInputs();
                toggleIdTypeVisibility();

                if (newAccountCreated) {
                    renderMainAppContent(); // Go to main app after new user registration
                } else {
                    activateTab('players'); // Go to player list after adding another player
                }
            });

            updateSelectedGamesDisplay();
            renderGameRankInputs();
            renderNavButtons(); // Ensure nav buttons are correctly rendered for the state
        };


        // --- Render Functions for Other Sections (remain largely the same) ---

        const renderPlayerList = () => {
            // Filter criteria state
            let filterCriteria = {
                idSearch: '',
                nameSearch: '',
                minAge: '', maxAge: '',
                minWeight: '', maxWeight: '',
                selectedGames: [],
                gameSpecificRankFilters: {} // { 'Game Name': 'Selected Rank' } for dropdowns, or text for others
            };
            let showAdvancedFilters = false; // State for advanced filter visibility

            const applyFilters = () => {
                let filteredPlayers = players;

                // Filter by ID (always active)
                if (filterCriteria.idSearch) {
                    const searchTerm = filterCriteria.idSearch.toLowerCase();
                    filteredPlayers = filteredPlayers.filter(player => {
                        // Direct match
                        if (player.id.toLowerCase().includes(searchTerm)) {
                            return true;
                        }
                        // For Silver IDs (5-digit numbers, might be searched without leading zeros)
                        if (player.id.length === 5 && !isNaN(player.id) && searchTerm.length < 5) {
                            const paddedSearchTerm = searchTerm.padStart(5, '0');
                            if (player.id.includes(paddedSearchTerm)) {
                                return true;
                            }
                        }
                        return false;
                    });
                }

                // Apply advanced filters only if they are visible
                if (showAdvancedFilters) {
                    // Filter by Name
                    if (filterCriteria.nameSearch) {
                        filteredPlayers = filteredPlayers.filter(player =>
                            player.name.toLowerCase().includes(filterCriteria.nameSearch.toLowerCase())
                        );
                    }

                    // Filter by Age
                    if (filterCriteria.minAge) {
                                                filteredPlayers = filteredPlayers.filter(player => player.age >= parseInt(filterCriteria.minAge));
                    }
                    if (filterCriteria.maxAge) {
                        filteredPlayers = filteredPlayers.filter(player => player.age <= parseInt(filterCriteria.maxAge));
                    }

                    // Filter by Weight
                    if (filterCriteria.minWeight) {
                        filteredPlayers = filteredPlayers.filter(player => player.weight >= parseInt(filterCriteria.minWeight));
                    }
                    if (filterCriteria.maxWeight) {
                        filteredPlayers = filteredPlayers.filter(player => player.weight <= parseInt(filterCriteria.maxWeight));
                    }

                    // Filter by Games Played (match any of the selected games)
                    if (filterCriteria.selectedGames.length > 0) {
                        filteredPlayers = filteredPlayers.filter(player =>
                            player.games && player.games.some(gameObj => filterCriteria.selectedGames.includes(gameObj.name))
                        );
                    }

                    // Filter by Game Specific Ranks
                    for (const gameName in filterCriteria.gameSpecificRankFilters) {
                        const selectedRank = filterCriteria.gameSpecificRankFilters[gameName];
                        if (selectedRank) {
                            filteredPlayers = filteredPlayers.filter(player =>
                                player.games && player.games.some(gameObj =>
                                    gameObj.name === gameName && gameObj.rank.toLowerCase().includes(selectedRank.toLowerCase())
                                )
                            );
                        }
                    }
                }

                renderPlayerCards(filteredPlayers);
            };

            const renderPlayerCards = (filteredPlayers) => {
                let playersHtml = '';
                if (filteredPlayers.length === 0) {
                    playersHtml = '<p class="col-span-full text-center text-gray-400">No players found matching your criteria.</p>';
                } else {
                    filteredPlayers.forEach(player => {
                        const gamesAndRanksHtml = player.games && player.games.length > 0
                            ? player.games.map(game => `<li>${game.name}: ${game.rank}</li>`).join('')
                            : '<li>N/A</li>';

                        let displayedPlayerId = player.id;
                        if (player.idType === 'silver' && player.id.length === 5 && !isNaN(player.id) && player.id.startsWith('0')) {
                            displayedPlayerId = parseInt(player.id).toString();
                        } else if (player.idType === 'special') {
                            displayedPlayerId = player.id.charAt(0).toUpperCase() + player.id.slice(1).toLowerCase();
                        }
                        // Check if the player's registeredBy ID is an admin ID and display it in uppercase
                        const registeredByUser = userAccounts.find(acc => acc.id === player.registeredBy);
                        const registeredByDisplay = registeredByUser && registeredByUser.isAdmin
                            ? `Registered by: ${registeredByUser.id.toUpperCase()}`
                            : `Registered by: ${player.registeredBy}`;

                        // Determine the frame class/style
                        const playerOwnerAccount = userAccounts.find(acc => acc.id === player.registeredBy);
                        const activeFrame = playerOwnerAccount?.activeFrame;
                        let frameClass = '';
                        let frameStyle = '';
                        let photoClass = 'w-20 h-20 rounded-full object-cover object-center';
                        let photoWrapperClass = 'relative w-20 h-20 rounded-full flex-shrink-0'; // Added for frame positioning

                        if (activeFrame) {
                            const frameData = shopItems.profileFrames.find(f => f.id === activeFrame);
                            if (frameData) {
                                if (frameData.type === 'border') {
                                    frameClass = frameData.value; // Tailwind border classes
                                    photoWrapperClass += ` ${frameClass}`;
                                    photoClass = 'w-full h-full rounded-full object-cover object-center'; // Make photo fill the bordered wrapper
                                } else if (frameData.type === 'custom-class') {
                                    // For custom classes that might apply to the text/image itself
                                    // This might require more complex rendering or SVG overlays for actual "frames"
                                    // For now, let's just apply it to the image wrapper or a div around it.
                                    photoWrapperClass += ` ${frameData.value}`;
                                    photoClass = 'w-full h-full rounded-full object-cover object-center';
                                }
                            }
                        }


                        playersHtml += `
                            <div class="flex items-center bg-gray-700 p-4 rounded-lg shadow-md border border-gray-600">
                                <div class="${photoWrapperClass} mr-4">
                                    <img src="${player.photoUrl}" onerror="this.onerror=null;this.src='https://placehold.co/100x100/CCCCCC/FFFFFF?text=Error';" alt="${player.name}" class="${photoClass}" />
                                </div>
                                <div class="flex-grow">
                                    <h3 class="text-lg font-semibold text-gray-100">${player.name}</h3>
                                    <p class="text-xs text-gray-400">ID: ${displayedPlayerId}</p>
                                    <p class="text-xs text-gray-500">${registeredByDisplay}</p>
                                    <div class="text-sm text-gray-300">
                                        <p>Age: ${player.age}</p>
                                        <p>Weight: ${player.weight} kg</p>
                                        <p class="font-semibold mt-1">Game Ranks:</p>
                                        <ul class="list-disc list-inside ml-2 text-xs text-gray-400">
                                            ${gamesAndRanksHtml}
                                        </ul>
                                    </div>
                                </div>
                                <button data-player-id="${player.id}" class="send-duel-btn ml-4 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-150 ease-in-out text-sm">
                                    Send Duel Request
                                </button>
                            </div>
                        `;
                    });
                }
                document.getElementById('playerCardsContainer').innerHTML = playersHtml;

                document.querySelectorAll('.send-duel-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const recipientPlayerId = e.target.dataset.playerId;
                        promptForDuelRequest(recipientPlayerId);
                    });
                });
            };

            const gameFilterOptionsHtml = gameCategories.map(game => `
                <label class="multi-select-dropdown-option">
                    <input type="checkbox" value="${game}" class="form-checkbox text-indigo-600 rounded-sm filter-game-checkbox">
                    <span class="ml-2">${game}</span>
                </label>
            `).join('');

            const gameSpecificRankFiltersHtml = gameCategories.map(game => {
                const ranks = gameRanksMap[game];
                if (ranks && Array.isArray(ranks)) {
                    const options = ranks.map(rank => `<option value="${rank}">${rank}</option>`).join('');
                    return `
                        <div>
                            <label for="filter-rank-${game.replace(/\s/g, '-')}" class="block text-sm font-medium text-gray-300">${game} Rank</label>
                            <select id="filter-rank-${game.replace(/\s/g, '-')}" data-game="${game}" class="filter-game-rank-select mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">-- Any Rank --</option>
                                ${options}
                            </select>
                        </div>
                    `;
                } else {
                    return `
                        <div>
                            <label for="filter-rank-${game.replace(/\s/g, '-')}" class="block text-sm font-medium text-gray-300">${game} Rank</label>
                            <input type="text" id="filter-rank-${game.replace(/\s/g, '-')}" data-game="${game}" placeholder="Search rank for ${game}" class="filter-game-rank-input mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    `;
                }
            }).join('');


            appContentDiv.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg w-full max-w-6xl mx-auto border border-gray-700">
                    <h2 class="text-2xl font-bold text-gray-100 mb-4">Available Players</h2>

                    <!-- Search by ID (always visible) -->
                    <div class="mb-4 p-4 border border-gray-700 rounded-lg bg-gray-700">
                        <label for="searchById" class="block text-sm font-medium text-gray-300">Search by ID</label>
                        <input type="text" id="searchById" placeholder="Enter Player ID" class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <!-- Advanced Filter Toggle Button -->
                    <button id="toggleAdvancedFiltersBtn" class="w-full py-2 px-4 mb-6 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-gray-600 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition duration-150 ease-in-out">
                        Show Advanced Filters
                    </button>

                    <!-- Advanced Filter Section (initially hidden) -->
                    <div id="advancedFilterSection" class="mb-6 p-4 border border-gray-700 rounded-lg bg-gray-700 hidden">
                        <h3 class="text-xl font-semibold text-gray-100 mb-3">Advanced Filters</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div>
                                <label for="searchByName" class="block text-sm font-medium text-gray-300">Search by Name</label>
                                <input type="text" id="searchByName" placeholder="Enter Player Name" class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label for="minAge" class="block text-sm font-medium text-gray-300">Min Age</label>
                                    <input type="number" id="minAge" placeholder="Min" class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div>
                                    <label for="maxAge" class="block text-sm font-medium text-gray-300">Max Age</label>
                                    <input type="number" id="maxAge" placeholder="Max" class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label for="minWeight" class="block text-sm font-medium text-gray-300">Min Weight (kg)</label>
                                    <input type="number" id="minWeight" placeholder="Min" class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div>
                                    <label for="maxWeight" class="block text-sm font-medium text-gray-300">Max Weight (kg)</label>
                                    <input type="number" id="maxWeight" placeholder="Max" class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300">Games Played</label>
                                <div class="multi-select-dropdown mt-1">
                                    <button type="button" id="filterGamesSelectBtn" class="w-full px-3 py-2 border border-gray-600 rounded-md shadow-sm bg-gray-800 text-left focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-gray-300">
                                        Filter by Games
                                    </button>
                                    <div id="filterGamesOptions" class="multi-select-dropdown-options hidden">
                                        ${gameFilterOptionsHtml}
                                    </div>
                                </div>
                                <div id="filterSelectedGamesDisplay" class="mt-2 text-sm text-gray-400"></div>
                            </div>
                            ${gameSpecificRankFiltersHtml} <!-- Dynamic game-specific rank filters -->
                        </div>
                        <button id="resetFiltersBtn" class="mt-4 w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-gray-500 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition duration-150 ease-in-out">
                            Reset Filters
                        </button>
                    </div>

                    <!-- Player Cards Container -->
                    <div id="playerCardsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Player cards will be rendered here -->
                    </div>
                </div>
            `;

            // Get filter elements
            const searchByIdInput = document.getElementById('searchById');
            const toggleAdvancedFiltersBtn = document.getElementById('toggleAdvancedFiltersBtn');
            const advancedFilterSection = document.getElementById('advancedFilterSection');
            const searchByNameInput = document.getElementById('searchByName');
            const minAgeInput = document.getElementById('minAge');
            const maxAgeInput = document.getElementById('maxAge');
            const minWeightInput = document.getElementById('minWeight');
            const maxWeightInput = document.getElementById('maxWeight');
            const filterGamesSelectBtn = document.getElementById('filterGamesSelectBtn');
            const filterGamesOptionsDiv = document.getElementById('filterGamesOptions');
            const filterGameCheckboxes = filterGamesOptionsDiv.querySelectorAll('.filter-game-checkbox');
            const filterSelectedGamesDisplay = document.getElementById('filterSelectedGamesDisplay');
            const resetFiltersBtn = document.getElementById('resetFiltersBtn');
            const filterGameRankInputs = document.querySelectorAll('.filter-game-rank-input, .filter-game-rank-select');


            const updateFilterSelectedGamesDisplay = () => {
                filterSelectedGamesDisplay.textContent = filterCriteria.selectedGames.length > 0 ? filterCriteria.selectedGames.join(', ') : 'No games selected';
                filterGamesSelectBtn.textContent = filterCriteria.selectedGames.length > 0 ? `Filtered (${filterCriteria.selectedGames.length})` : 'Filter by Games';
            };

            // Event listeners for filter inputs
            searchByIdInput.addEventListener('input', (e) => { filterCriteria.idSearch = e.target.value; applyFilters(); });
            searchByNameInput.addEventListener('input', (e) => { filterCriteria.nameSearch = e.target.value; applyFilters(); });
            minAgeInput.addEventListener('input', (e) => { filterCriteria.minAge = e.target.value; applyFilters(); });
            maxAgeInput.addEventListener('input', (e) => { filterCriteria.maxAge = e.target.value; applyFilters(); });
            minWeightInput.addEventListener('input', (e) => { filterCriteria.minWeight = e.target.value; applyFilters(); });
            maxWeightInput.addEventListener('input', (e) => { filterCriteria.maxWeight = e.target.value; applyFilters(); });

            filterGamesSelectBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                filterGamesOptionsDiv.classList.toggle('hidden');
            });

            filterGameCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    filterCriteria.selectedGames = Array.from(filterGameCheckboxes)
                        .filter(cb => cb.checked)
                        .map(cb => cb.value);
                    updateFilterSelectedGamesDisplay();
                    applyFilters();
                });
            });

            filterGameRankInputs.forEach(input => {
                input.addEventListener('input', (e) => { // For text inputs
                    const game = e.target.dataset.game;
                    filterCriteria.gameSpecificRankFilters[game] = e.target.value;
                    applyFilters();
                });
                 input.addEventListener('change', (e) => { // For select elements
                    const game = e.target.dataset.game;
                    filterCriteria.gameSpecificRankFilters[game] = e.target.value;
                    applyFilters();
                });
            });


            document.addEventListener('click', (e) => {
                if (!filterGamesOptionsDiv.contains(e.target) && e.target !== filterGamesSelectBtn) {
                    filterGamesOptionsDiv.classList.add('hidden');
                }
            });

            resetFiltersBtn.addEventListener('click', () => {
                filterCriteria = {
                    idSearch: '', nameSearch: '',
                    minAge: '', maxAge: '',
                    minWeight: '', maxWeight: '',
                    selectedGames: [],
                    gameSpecificRankFilters: {}
                };
                searchByIdInput.value = '';
                searchByNameInput.value = '';
                minAgeInput.value = ''; maxAgeInput.value = '';
                minWeightInput.value = ''; maxWeightInput.value = '';
                filterGameCheckboxes.forEach(cb => cb.checked = false);
                filterGameRankInputs.forEach(input => input.value = ''); // Clear game rank filters
                updateFilterSelectedGamesDisplay();
                applyFilters();
            });

            // Toggle Advanced Filters visibility
            toggleAdvancedFiltersBtn.addEventListener('click', () => {
                showAdvancedFilters = !showAdvancedFilters;
                advancedFilterSection.classList.toggle('hidden', !showAdvancedFilters);
                toggleAdvancedFiltersBtn.textContent = showAdvancedFilters ? 'Hide Advanced Filters' : 'Show Advanced Filters';
                applyFilters(); // Re-apply filters when visibility changes
            });


            applyFilters(); // Initial render of players with no filters
            updateFilterSelectedGamesDisplay(); // Initial display for filter games
        };

        const promptForDuelRequest = (recipientPlayerId) => {
            const recipientPlayer = players.find(p => p.id === recipientPlayerId);
            if (!recipientPlayer) {
                showModal('Error', 'Recipient player not found.');
                return;
            }

            const currentUserPlayers = players.filter(p => p.registeredBy === loggedInUserId);
            if (currentUserPlayers.length === 0) {
                showModal('Error', 'You must register at least one player profile before sending duel requests.');
                return;
            }

            const playerOptionsHtml = currentUserPlayers.map(p => `
                <option value="${p.id}">${p.name} (ID: ${p.id})</option>
            `).join('');

            showModal('Send Duel Request', `
                <div class="space-y-4">
                    <p class="text-lg text-gray-200">Requesting duel with: <span class="font-semibold">${recipientPlayer.name} (ID: ${recipientPlayer.id})</span></p>
                    <div>
                        <label for="sendingPlayerSelect" class="block text-sm font-medium text-gray-300">Your Player:</label>
                        <select id="sendingPlayerSelect" class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md shadow-sm bg-gray-700 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            ${playerOptionsHtml}
                        </select>
                    </div>
                    <div>
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="enableBettingCheckbox" class="form-checkbox text-indigo-600 rounded-sm" checked>
                            <span class="ml-2 text-gray-300">Enable Betting (1000 â‚® default)</span>
                        </label>
                    </div>
                    <div id="betAmountContainer" class="mt-2">
                        <label for="proposedBetAmount" class="block text-sm font-medium text-gray-300">Proposed Bet Amount (â‚®)</label>
                        <input type="number" id="proposedBetAmount" value="1000" min="10" class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md shadow-sm bg-gray-700 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <button id="confirmSendDuelBtn" class="w-full py-2 px-4 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-150 ease-in-out font-medium">
                        Send Request
                    </button>
                </div>
            `);

            const enableBettingCheckbox = document.getElementById('enableBettingCheckbox');
            const betAmountContainer = document.getElementById('betAmountContainer');
            const proposedBetAmountInput = document.getElementById('proposedBetAmount');

            enableBettingCheckbox.addEventListener('change', () => {
                betAmountContainer.classList.toggle('hidden', !enableBettingCheckbox.checked);
                proposedBetAmountInput.required = enableBettingCheckbox.checked;
            });

            document.getElementById('confirmSendDuelBtn').addEventListener('click', () => {
                const sendingPlayerId = document.getElementById('sendingPlayerSelect').value;
                const sendingPlayer = players.find(p => p.id === sendingPlayerId);

                if (!sendingPlayer) {
                    showModal('Error', 'Your selected player not found.');
                    return;
                }
                if (sendingPlayer.id === recipientPlayerId) {
                    showModal('Error', 'You cannot send a duel request to your own player profile.');
                    return;
                }

                const bettingEnabled = enableBettingCheckbox.checked;
                const proposedBetAmount = bettingEnabled ? parseInt(proposedBetAmountInput.value) : 0;

                if (bettingEnabled && (isNaN(proposedBetAmount) || proposedBetAmount <= 0)) {
                    showModal('Error', 'Please enter a valid bet amount for the duel.');
                    return;
                }

                const existingRequest = duelRequests.find(req =>
                    req.requesterId === sendingPlayer.id &&
                    req.recipientId === recipientPlayerId &&
                    req.status === 'pending'
                );

                if (existingRequest) {
                    showModal('Error', 'A pending duel request already exists for this player.');
                    return;
                }

                const newRequest = {
                    id: generateUniqueId(),
                    requesterId: sendingPlayer.id,
                    recipientId: recipientPlayerId,
                    status: 'pending',
                    timestamp: new Date().toISOString(),
                    bettingEnabled: bettingEnabled,
                    proposedBetAmount: proposedBetAmount
                };

                duelRequests.push(newRequest);
                saveState();
                hideModal();
                showModal('Duel Request Status', `Duel request sent to ${recipientPlayer.name} from ${sendingPlayer.name}! ${bettingEnabled ? `Proposed bet: ${proposedBetAmount.toLocaleString()} â‚®` : 'No betting.'}`);
                activateTab('requests'); // Go to requests tab
            });
        };


        const renderDuelRequests = () => {
            const currentUserPlayers = players.filter(p => p.registeredBy === loggedInUserId);
            const currentUserPlayerIds = new Set(currentUserPlayers.map(p => p.id));

            const incomingRequests = duelRequests.filter(req =>
                currentUserPlayerIds.has(req.recipientId) && req.status === 'pending'
            );

            let requestsHtml = '';
            if (incomingRequests.length === 0) {
                requestsHtml = '<p class="text-center text-gray-400">No pending duel requests.</p>';
            } else {
                incomingRequests.forEach(request => {
                    const requesterPlayer = players.find(p => p.id === request.requesterId);
                    const recipientPlayer = players.find(p => p.id === request.recipientId);
                    const betInfo = request.bettingEnabled ? ` (Bet: ${request.proposedBetAmount.toLocaleString()} â‚®)` : ' (No Bet)';

                    requestsHtml += `
                        <div class="flex items-center justify-between bg-gray-700 p-4 rounded-lg shadow-md border border-gray-600">
                            <div>
                                <p class="text-lg font-semibold text-gray-100">
                                    ${requesterPlayer?.name || 'Unknown Player'} wants to duel with ${recipientPlayer?.name || 'your player'}!
                                </p>
                                <p class="text-sm text-gray-400">Status: ${request.status}${betInfo}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button data-request-id="${request.id}" class="accept-duel-btn px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition duration-150 ease-in-out text-sm">
                                    Accept
                                </button>
                                <button data-request-id="${request.id}" class="decline-duel-btn px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition duration-150 ease-in-out text-sm">
                                    Decline
                                </button>
                            </div>
                        </div>
                    `;
                });
            }

            appContentDiv.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg w-full max-w-4xl mx-auto mb-6 border border-gray-700">
                    <h2 class="text-2xl font-bold text-gray-100 mb-4">Incoming Duel Requests</h2>
                    <div class="space-y-4">
                        ${requestsHtml}
                    </div>
                </div>
            `;

            document.querySelectorAll('.accept-duel-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const requestId = e.target.dataset.requestId;
                    handleAcceptDuel(requestId);
                });
            });

            document.querySelectorAll('.decline-duel-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const requestId = e.target.dataset.requestId;
                    handleDeclineDuel(requestId);
                });
            });
        };

        const handleAcceptDuel = (requestId) => {
            const requestIndex = duelRequests.findIndex(req => req.id === requestId);
            if (requestIndex > -1) {
                const acceptedRequest = duelRequests[requestIndex];

                // Deduct bet amount from both users if betting is enabled
                if (acceptedRequest.bettingEnabled && acceptedRequest.proposedBetAmount > 0) {
                    const requesterUser = userAccounts.find(acc => players.find(p => p.id === acceptedRequest.requesterId)?.registeredBy === acc.id);
                    const recipientUser = userAccounts.find(acc => players.find(p => p.id === acceptedRequest.recipientId)?.registeredBy === acc.id);

                    if (!requesterUser || requesterUser.balance < acceptedRequest.proposedBetAmount) {
                        showModal('Payment Error', `Requester (${requesterUser?.id || 'Unknown'}) has insufficient balance to cover the bet.`);
                        return;
                    }
                    if (!recipientUser || recipientUser.balance < acceptedRequest.proposedBetAmount) {
                        showModal('Payment Error', `You (${recipientUser?.id || 'Unknown'}) have insufficient balance to cover the bet.`);
                        return;
                    }

                    requesterUser.balance -= acceptedRequest.proposedBetAmount;
                    recipientUser.balance -= acceptedRequest.proposedBetAmount;
                    // Update current user's balance if they are involved
                    if (requesterUser.id === loggedInUserId) currentUserBalance = requesterUser.balance;
                    if (recipientUser.id === loggedInUserId) currentUserBalance = recipientUser.balance;
                }

                duelRequests[requestIndex].status = 'accepted';

                const newDuel = {
                    id: generateUniqueId(),
                    player1Id: acceptedRequest.requesterId,
                    player2Id: acceptedRequest.recipientId,
                    status: 'ongoing',
                    timestamp: new Date().toISOString(),
                    bettingEnabled: acceptedRequest.bettingEnabled,
                    betAmount: acceptedRequest.proposedBetAmount // Store the actual bet amount
                };
                activeDuels.push(newDuel);
                saveState();
                showModal('Duel Request Action', 'Duel accepted and moved to active duels!');
                activateTab('duels'); // Go to active duels
            }
        };

        const handleDeclineDuel = (requestId) => {
            const requestIndex = duelRequests.findIndex(req => req.id === requestId);
            if (requestIndex > -1) {
                duelRequests[requestIndex].status = 'declined';
                saveState();
                showModal('Duel Request Action', 'Duel declined.');
                renderDuelRequests(); // Re-render to update the list
            }
        };

        const renderActiveDuels = () => {
            const ongoingDuels = activeDuels.filter(duel => duel.status === 'ongoing');
            let duelsHtml = '';

            if (ongoingDuels.length === 0) {
                duelsHtml = '<p class="text-center text-gray-400">No duels currently active.</p>';
            } else {
                ongoingDuels.forEach(duel => {
                    const player1 = players.find(p => p.id === duel.player1Id);
                    const player2 = players.find(p => p.id === duel.player2Id);
                    // Display Silver IDs without leading zeros for readability in duel cards
                    const displayedPlayer1Id = (player1?.idType === 'silver' && player1?.id.length === 5 && !isNaN(player1?.id) && player1?.id.startsWith('0'))
                        ? parseInt(player1.id).toString()
                        : (player1?.idType === 'special' ? player1.id.charAt(0).toUpperCase() + player1.id.slice(1).toLowerCase() : player1?.id);
                    const displayedPlayer2Id = (player2?.idType === 'silver' && player2?.id.length === 5 && !isNaN(player2?.id) && player2?.id.startsWith('0'))
                        ? parseInt(player2.id).toString()
                        : (player2?.idType === 'special' ? player2.id.charAt(0).toUpperCase() + player2.id.slice(1).toLowerCase() : player2?.id);

                    const betInfo = duel.bettingEnabled ? ` (Bet: ${duel.betAmount.toLocaleString()} â‚®)` : ' (No Bet)';

                    duelsHtml += `
                        <div class="bg-gradient-to-br from-purple-800 to-indigo-800 p-4 rounded-lg shadow-md border border-purple-700">
                            <div class="flex items-center justify-center space-x-4 mb-3">
                                <img src="${player1?.photoUrl || 'https://placehold.co/60x60/CCCCCC/FFFFFF?text=P1'}" onerror="this.onerror=null;this.src='https://placehold.co/60x60/CCCCCC/FFFFFF?text=Error';" alt="Player 1" class="w-16 h-16 rounded-full object-cover object-center border-2 border-purple-500" />
                                <span class="text-xl font-bold text-purple-300">VS</span>
                                <img src="${player2?.photoUrl || 'https://placehold.co/60x60/CCCCCC/FFFFFF?text=P2'}" onerror="this.onerror=null;this.src='https://placehold.co/60x60/CCCCCC/FFFFFF?text=Error';" alt="Player 2" class="w-16 h-16 rounded-full object-cover object-center border-2 border-purple-500" />
                            </div>
                            <p class="text-center text-lg font-semibold text-gray-100 mb-2">
                                ${player1?.name || 'Player 1'} (ID: ${displayedPlayer1Id}) vs ${player2?.name || 'Player 2'} (ID: ${displayedPlayer2Id})
                            </p>
                            <p class="text-center text-sm text-gray-400 mb-3">Status: <span class="font-medium text-green-400">${duel.status.toUpperCase()}</span>${betInfo}</p>
                            <button data-duel-id="${duel.id}" class="view-stream-btn w-full py-2 px-4 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition duration-150 ease-in-out font-medium shadow-lg">
                                View Stream & Bet
                            </button>
                        </div>
                    `;
                });
            }

            appContentDiv.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg w-full max-w-4xl mx-auto mb-6 border border-gray-700">
                    <h2 class="text-2xl font-bold text-gray-100 mb-4">Active Duels</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        ${duelsHtml}
                    </div>
                </div>
            `;

            document.querySelectorAll('.view-stream-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const duelId = e.target.dataset.duelId;
                    selectedDuel = activeDuels.find(d => d.id === duelId);
                    if (selectedDuel) {
                        renderDuelStreamAndBetting(selectedDuel);
                    }
                });
            });
        };

        const renderDuelStreamAndBetting = (duel) => {
            const player1 = players.find(p => p.id === duel.player1Id);
            const player2 = players.find(p => p.id === duel.player2Id);

            const currentDuelBets = bets.filter(bet => bet.duelId === duel.id);
            const totalBetsPlayer1 = currentDuelBets.filter(bet => bet.betOnPlayerId === duel.player1Id).reduce((sum, bet) => sum + bet.betAmount, 0);
            const totalBetsPlayer2 = currentDuelBets.filter(bet => bet.betOnPlayerId === duel.player2Id).reduce((sum, bet) => sum + bet.betAmount, 0);

            let betsListHtml = '';
            if (currentDuelBets.length === 0) {
                betsListHtml = '<p class="text-center text-gray-400 text-sm">No bets placed yet.</p>';
            } else {
                currentDuelBets.forEach(bet => {
                    const betOnPlayer = players.find(p => p.id === bet.betOnPlayerId);
                    betsListHtml += `
                        <li class="text-sm text-gray-300 border-b border-gray-700 pb-1 last:border-b-0">
                            User <span class="font-semibold">${bet.bettorId.substring(0, 6)}...</span> bet <span class="font-semibold">${bet.betAmount.toLocaleString()} â‚®</span> on <span class="font-semibold">${betOnPlayer?.name || 'Unknown'}</span>
                        </li>
                    `;
                });
            }

            appContentDiv.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg w-full max-w-5xl mx-auto border border-gray-700">
                    <h2 class="text-2xl font-bold text-gray-100 mb-4">
                        Live Duel: ${player1?.name || 'Player 1'} vs ${player2?.name || 'Player 2'}
                    </h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Live Stream Section -->
                        <div class="md:col-span-1">
                            <h3 class="text-xl font-semibold text-gray-300 mb-3">Live Stream (Simulated)</h3>
                            <div class="relative w-full pb-[56.25%] rounded-lg overflow-hidden shadow-lg bg-gray-900">
                                <iframe
                                    class="absolute top-0 left-0 w-full h-full"
                                    src="https://www.youtube.com/embed/dQw4w9WgXcQ?autoplay=1&mute=1"
                                    title="Simulated Live Stream"
                                    frameborder="0"
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                    allowfullscreen
                                ></iframe>
                            </div>
                            <p class="text-sm text-gray-400 mt-2">
                                *This is a simulated live stream. In a real application, this would be a live video feed.
                            </p>
                        </div>

                        <!-- Betting Section -->
                        <div class="md:col-span-1">
                            <h3 class="text-xl font-semibold text-gray-300 mb-3">Place Your Bets!</h3>
                            ${duel.bettingEnabled ? `
                                <div class="bg-gray-700 p-4 rounded-lg shadow-inner mb-4 border border-gray-600">
                                    <div class="mb-4">
                                        <label for="betPlayer" class="block text-sm font-medium text-gray-300 mb-1">Bet on:</label>
                                        <select id="betPlayer" class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                            <option value="">Select a player</option>
                                            <option value="${duel.player1Id}">${player1?.name}</option>
                                            <option value="${duel.player2Id}">${player2?.name}</option>
                                        </select>
                                    </div>
                                    <div class="mb-4">
                                        <label for="betAmount" class="block text-sm font-medium text-gray-300 mb-1">Bet Amount (Virtual Currency)</label>
                                        <input type="number" id="betAmount" value="10" class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" min="1" required>
                                    </div>
                                    <button id="placeBetBtn" class="w-full py-2 px-4 bg-green-600 text-white rounded-md hover:bg-green-700 transition duration-150 ease-in-out font-medium shadow-lg">
                                        Place Bet
                                    </button>
                                </div>
                            ` : `
                                <p class="text-center text-gray-400 p-4 bg-gray-700 rounded-lg border border-gray-600">
                                    Betting is not enabled for this duel.
                                </p>
                            `}

                            <h3 class="text-xl font-semibold text-gray-300 mb-3">Real-time Bets</h3>
                            <div class="bg-gray-700 p-4 rounded-lg shadow-inner border border-gray-600">
                                <div class="flex justify-around text-center mb-3">
                                    <div>
                                        <p class="text-sm text-gray-400">Total Bets on ${player1?.name}:</p>
                                        <p class="text-2xl font-bold text-blue-400">${totalBetsPlayer1.toLocaleString()} â‚®</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-400">Total Bets on ${player2?.name}:</p>
                                        <p class="2xl font-bold text-red-400">${totalBetsPlayer2.toLocaleString()} â‚®</p>
                                    </div>
                                </div>
                                <div class="max-h-40 overflow-y-auto border border-gray-600 rounded-md p-2">
                                    <ul class="space-y-1">
                                        ${betsListHtml}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button id="closeStreamBtn" class="mt-6 w-full py-3 px-4 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition duration-150 ease-in-out font-medium shadow-lg">
                        Close Stream
                    </button>
                </div>
            `;

            if (duel.bettingEnabled) {
                document.getElementById('placeBetBtn').addEventListener('click', () => {
                    const betAmount = parseInt(document.getElementById('betAmount').value);
                    const betOnPlayerId = document.getElementById('betPlayer').value;

                    if (!betOnPlayerId || betAmount <= 0) {
                        showModal('Betting Error', 'Please select a player and enter a valid bet amount.');
                        return;
                    }
                    if (currentUserBalance < betAmount) {
                        showModal('Betting Error', `Insufficient balance. You need ${betAmount.toLocaleString()} â‚® but have ${currentUserBalance.toLocaleString()} â‚®.`);
                        return;
                    }

                    // Deduct balance from current user
                    const currentUserAccount = userAccounts.find(acc => acc.id === loggedInUserId);
                    if (currentUserAccount) {
                        currentUserAccount.balance -= betAmount;
                        currentUserBalance = currentUserAccount.balance;
                        document.getElementById('userBalanceDisplay').textContent = currentUserBalance.toLocaleString() + ' â‚®';
                    }

                    const newBet = {
                        id: generateUniqueId(),
                        duelId: duel.id,
                        bettorId: loggedInUserId,
                        betAmount: betAmount,
                        betOnPlayerId: betOnPlayerId,
                        timestamp: new Date().toISOString(),
                    };

                    bets.push(newBet);
                    saveState();
                    showModal('Betting Status', `Bet of ${betAmount.toLocaleString()} â‚® placed on ${players.find(p => p.id === betOnPlayerId)?.name || 'selected player'}!`);
                    renderDuelStreamAndBetting(duel); // Re-render to update bets list
                });
            }

            document.getElementById('closeStreamBtn').addEventListener('click', () => {
                selectedDuel = null;
                activateTab('duels'); // Go back to active duels list
            });
        };

        // --- Render Shop Section ---
        const renderShop = () => {
            const currentUserAccount = userAccounts.find(acc => acc.id === loggedInUserId);
            const userPurchasedFrames = currentUserAccount?.purchasedFrames || [];
            const userActiveFrame = currentUserAccount?.activeFrame;

            const coinPurchaseOptions = shopItems.coins.map(item => `
                <div class="bg-gray-700 p-4 rounded-lg shadow-md border border-gray-600 text-center">
                    <p class="text-xl font-bold text-yellow-400 mb-2">${item.amount} Coins</p>
                    <p class="text-gray-300 mb-4">Cost: ${item.tugrugCost.toLocaleString()} â‚®</p>
                    <button data-amount="${item.amount}" data-cost="${item.tugrugCost}" class="buy-coins-btn w-full py-2 px-4 bg-green-600 text-white rounded-md hover:bg-green-700 transition duration-150 ease-in-out font-medium">
                        Buy Now
                    </button>
                </div>
            `).join('');

            const profileFrameOptions = shopItems.profileFrames.map(frame => {
                const isPurchased = userPurchasedFrames.includes(frame.id);
                const isActive = userActiveFrame === frame.id;
                let buttonHtml = '';

                if (isActive) {
                    buttonHtml = `<button class="w-full py-2 px-4 bg-gray-500 text-white rounded-md cursor-not-allowed font-medium" disabled>Equipped</button>`;
                } else if (isPurchased) {
                    buttonHtml = `<button data-frame-id="${frame.id}" class="equip-frame-btn w-full py-2 px-4 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-150 ease-in-out font-medium">Equip</button>`;
                } else {
                    buttonHtml = `<button data-frame-id="${frame.id}" data-cost="${frame.cost}" class="buy-frame-btn w-full py-2 px-4 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition duration-150 ease-in-out font-medium">Buy (${frame.cost} ðŸª™)</button>`;
                }

                let frameDisplayClass = '';
                let frameDisplayContent = '';
                if (frame.type === 'border') {
                    frameDisplayClass = frame.value;
                    frameDisplayContent = `<div class="w-full h-full rounded-full bg-gray-600 flex items-center justify-center text-lg">ðŸ–¼ï¸</div>`;
                } else if (frame.type === 'custom-class') {
                    frameDisplayClass = frame.value;
                    frameDisplayContent = `<div class="w-full h-full rounded-full bg-gray-600 flex items-center justify-center text-lg">âœ¨</div>`;
                }

                return `
                    <div class="bg-gray-700 p-4 rounded-lg shadow-md border border-gray-600 text-center">
                        <p class="text-lg font-bold text-gray-100 mb-2">${frame.name}</p>
                        <div class="frame-preview mx-auto mb-4 ${frameDisplayClass}">
                            ${frameDisplayContent}
                        </div>
                        ${buttonHtml}
                    </div>
                `;
            }).join('');

            const currentUserPlayers = players.filter(p => p.registeredBy === loggedInUserId);
            const playerOptionsForIdChange = currentUserPlayers.map(p => `
                <option value="${p.id}">${p.name} (ID: ${p.id})</option>
            `).join('');

            appContentDiv.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg w-full max-w-6xl mx-auto border border-gray-700">
                    <h2 class="text-2xl font-bold text-gray-100 mb-6">Shop</h2>

                    <!-- Buy Coins Section -->
                    <section class="mb-8">
                        <h3 class="text-xl font-semibold text-gray-200 mb-4">Buy Coins</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                            ${coinPurchaseOptions}
                        </div>
                    </section>

                    <!-- Profile Frames Section -->
                    <section class="mb-8">
                        <h3 class="text-xl font-semibold text-gray-200 mb-4">Profile Frames</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            ${profileFrameOptions}
                        </div>
                    </section>

                    <!-- Change Player ID Section -->
                    <section>
                        <h3 class="text-xl font-semibold text-gray-200 mb-4">Change Player ID (Cost: ${shopItems.playerIDChangeCost} ðŸª™)</h3>
                        <div class="bg-gray-700 p-6 rounded-lg shadow-md border border-gray-600 space-y-4">
                            <div>
                                <label for="playerToChangeId" class="block text-sm font-medium text-gray-300">Select Player</label>
                                <select id="playerToChangeId" class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md shadow-sm bg-gray-800 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="">-- Select Your Player --</option>
                                    ${playerOptionsForIdChange}
                                </select>
                            </div>

                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-300">New ID Type</label>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                    <label class="inline-flex items-center p-2 border border-gray-600 rounded-md cursor-pointer hover:bg-gray-700">
                                        <input type="radio" name="changeIdType" value="normal" checked class="form-radio text-indigo-500" id="changeNormalIdRadio">
                                        <span class="ml-2 text-gray-300">Normal ID (Free)</span>
                                    </label>
                                    <label class="inline-flex items-center p-2 border border-gray-600 rounded-md cursor-pointer hover:bg-gray-700 ${getAvailableSilverIds().length === 0 ? 'opacity-50 cursor-not-allowed' : ''}">
                                        <input type="radio" name="changeIdType" value="silver" class="form-radio text-indigo-500" id="changeSilverIdRadio" ${getAvailableSilverIds().length === 0 ? 'disabled' : ''}>
                                        <span class="ml-2 text-gray-300">Silver ID (${SILVER_ID_COST.toLocaleString()} â‚®)</span>
                                    </label>
                                    <label class="inline-flex items-center p-2 border border-gray-600 rounded-md cursor-pointer hover:bg-gray-700 ${getAvailableGoldenIds().length === 0 ? 'opacity-50 cursor-not-allowed' : ''}">
                                        <input type="radio" name="changeIdType" value="golden" class="form-radio text-indigo-500" id="changeGoldenIdRadio" ${getAvailableGoldenIds().length === 0 ? 'disabled' : ''}>
                                        <span class="ml-2 text-gray-300">Golden ID (${GOLDEN_ID_COST.toLocaleString()} â‚®)</span>
                                    </label>
                                    <label class="inline-flex items-center p-2 border border-gray-600 rounded-md cursor-pointer hover:bg-gray-700">
                                        <input type="radio" name="changeIdType" value="special" class="form-radio text-indigo-500" id="changeSpecialIdRadio">
                                        <span class="ml-2 text-gray-300">Special ID (${SPECIAL_ID_COST.toLocaleString()} â‚®)</span>
                                    </label>
                                </div>

                                <div id="changeSilverIdSelection" class="mt-2 hidden">
                                    <label for="changeSilverId" class="block text-sm font-medium text-gray-300">Select Silver ID</label>
                                    <select id="changeSilverId" class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                        <option value="">-- Select --</option>
                                        ${getAvailableSilverIds().map(id => `<option value="${id}">${parseInt(id)}</option>`).join('')}
                                    </select>
                                </div>
                                <div id="changeGoldenIdSelection" class="mt-2 hidden">
                                    <label for="changeGoldenId" class="block text-sm font-medium text-gray-300">Select Golden ID</label>
                                    <select id="changeGoldenId" class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                        <option value="">-- Select --</option>
                                        ${getAvailableGoldenIds().map(id => `<option value="${id}">${id}</option>`).join('')}
                                    </select>
                                </div>
                                <div id="changeSpecialIdInput" class="mt-2 hidden">
                                    <label for="changeCustomSpecialId" class="block text-sm font-medium text-gray-300">Enter Custom Special ID (No numbers, 3+ chars)</label>
                                    <input type="text" id="changeCustomSpecialId" placeholder="e.g., NEWDUELID" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                            </div>
                            <button id="confirmIdChangeBtn" class="w-full py-2 px-4 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-150 ease-in-out font-medium">
                                Change ID
                            </button>
                        </div>
                    </section>
                </div>
            `;

            // Buy Coins Logic
            document.querySelectorAll('.buy-coins-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const amount = parseInt(e.target.dataset.amount);
                    const cost = parseInt(e.target.dataset.cost);
                    const user = userAccounts.find(acc => acc.id === loggedInUserId);

                    if (!user) {
                        showModal('Error', 'User not logged in.');
                        return;
                    }
                    if (user.balance < cost) {
                        showModal('Insufficient Funds', `You need ${cost.toLocaleString()} â‚® to buy ${amount} coins, but you only have ${user.balance.toLocaleString()} â‚®.`);
                        return;
                    }

                    user.balance -= cost;
                    user.coins += amount;
                    saveState();
                    updateBalanceDisplay();
                    showModal('Purchase Successful', `You bought ${amount} coins for ${cost.toLocaleString()} â‚®! Your new balance: ${user.balance.toLocaleString()} â‚®, Coins: ${user.coins.toLocaleString()} ðŸª™.`);
                    renderShop(); // Re-render shop to update coin counts and button states
                });
            });

            // Profile Frames Logic
            document.querySelectorAll('.buy-frame-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const frameId = e.target.dataset.frameId;
                    const cost = parseInt(e.target.dataset.cost);
                    const user = userAccounts.find(acc => acc.id === loggedInUserId);

                    if (!user) {
                        showModal('Error', 'User not logged in.');
                        return;
                    }
                    if (user.coins < cost) {
                        showModal('Insufficient Coins', `You need ${cost} coins to buy this frame, but you only have ${user.coins.toLocaleString()} ðŸª™.`);
                        return;
                    }

                    user.coins -= cost;
                    user.purchasedFrames.push(frameId);
                    saveState();
                    updateBalanceDisplay();
                    showModal('Purchase Successful', `You bought "${shopItems.profileFrames.find(f => f.id === frameId).name}" for ${cost} coins! Your new coin balance: ${user.coins.toLocaleString()} ðŸª™.`);
                    renderShop(); // Re-render shop to update button states
                });
            });

            document.querySelectorAll('.equip-frame-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const frameId = e.target.dataset.frameId;
                    const user = userAccounts.find(acc => acc.id === loggedInUserId);

                    if (!user) {
                        showModal('Error', 'User not logged in.');
                        return;
                    }

                    user.activeFrame = frameId;
                    saveState();
                    showModal('Frame Equipped', `You equipped "${shopItems.profileFrames.find(f => f.id === frameId).name}".`);
                    renderShop(); // Re-render shop to update button states
                    activateTab('players'); // Go to player list to see the change
                });
            });

            // Change Player ID Logic
            const playerToChangeIdSelect = document.getElementById('playerToChangeId');
            const changeIdTypeRadios = document.querySelectorAll('input[name="changeIdType"]');
            const changeSilverIdSelectionDiv = document.getElementById('changeSilverIdSelection');
            const changeGoldenIdSelectionDiv = document.getElementById('changeGoldenIdSelection');
            const changeSpecialIdInputDiv = document.getElementById('changeSpecialIdInput');
            const changeSilverIdSelect = document.getElementById('changeSilverId');
            const changeGoldenIdSelect = document.getElementById('changeGoldenId');
            const changeCustomSpecialIdInput = document.getElementById('changeCustomSpecialId');
            const confirmIdChangeBtn = document.getElementById('confirmIdChangeBtn');

            const toggleChangeIdTypeVisibility = () => {
                changeSilverIdSelectionDiv.classList.add('hidden');
                changeGoldenIdSelectionDiv.classList.add('hidden');
                changeSpecialIdInputDiv.classList.add('hidden');

                const selectedIdType = document.querySelector('input[name="changeIdType"]:checked').value;
                if (selectedIdType === 'silver') {
                    changeSilverIdSelectionDiv.classList.remove('hidden');
                } else if (selectedIdType === 'golden') {
                    changeGoldenIdSelectionDiv.classList.remove('hidden');
                } else if (selectedIdType === 'special') {
                    changeSpecialIdInputDiv.classList.remove('hidden');
                }
            };

            changeIdTypeRadios.forEach(radio => radio.addEventListener('change', toggleChangeIdTypeVisibility));
            toggleChangeIdTypeVisibility(); // Initial call

            confirmIdChangeBtn.addEventListener('click', () => {
                const selectedPlayerId = playerToChangeIdSelect.value;
                if (!selectedPlayerId) {
                    showModal('Error', 'Please select a player to change their ID.');
                    return;
                }

                const playerToUpdate = players.find(p => p.id === selectedPlayerId);
                if (!playerToUpdate) {
                    showModal('Error', 'Selected player not found.');
                    return;
                }

                const userAccount = userAccounts.find(acc => acc.id === loggedInUserId);
                if (!userAccount) {
                    showModal('Error', 'User not logged in.');
                    return;
                }

                if (userAccount.coins < shopItems.playerIDChangeCost) {
                    showModal('Insufficient Coins', `You need ${shopItems.playerIDChangeCost} coins to change a player ID, but you only have ${userAccount.coins.toLocaleString()} ðŸª™.`);
                    return;
                }

                const newIdType = document.querySelector('input[name="changeIdType"]:checked').value;
                let newPlayerId;
                let newIdCost = 0; // Additional cost for ID type itself

                // Release old special ID if applicable
                if (playerToUpdate.idType !== 'normal' && usedSpecialIds.has(playerToUpdate.id)) {
                    usedSpecialIds.delete(playerToUpdate.id);
                }

                if (newIdType === 'normal') {
                    newPlayerId = generateNormalId();
                } else if (newIdType === 'silver') {
                    newPlayerId = changeSilverIdSelect.value;
                    if (!newPlayerId) { showModal('Error', 'Please select a Silver ID.'); return; }
                    if (isIdUsed(newPlayerId, true)) { showModal('Error', 'Selected Silver ID is already taken.'); return; }
                    newIdCost = SILVER_ID_COST;
                } else if (newIdType === 'golden') {
                    newPlayerId = changeGoldenIdSelect.value;
                    if (!newPlayerId) { showModal('Error', 'Please select a Golden ID.'); return; }
                    if (isIdUsed(newPlayerId, true)) { showModal('Error', 'Selected Golden ID is already taken.'); return; }
                    newIdCost = GOLDEN_ID_COST;
                } else if (newIdType === 'special') {
                    newPlayerId = changeCustomSpecialIdInput.value.trim();
                    if (!newPlayerId) { showModal('Error', 'Please enter a custom Special ID.'); return; }
                    if (newPlayerId.length < 3) { showModal('Error', 'Special ID must be at least 3 characters long.'); return; }
                    if (/\d/.test(newPlayerId)) { showModal('Error', 'Special ID cannot contain numbers.'); return; }
                    if (isIdUsed(newPlayerId, true)) { showModal('Error', 'This custom Special ID is already taken.'); return; }
                    newIdCost = SPECIAL_ID_COST;
                }

                // Check if user has enough Tugrug for the new ID type (if applicable)
                if (newIdCost > 0 && userAccount.balance < newIdCost) {
                    showModal('Payment Error', `Insufficient balance. You need ${newIdCost.toLocaleString()} â‚® for this ID type.`);
                    return;
                }

                // Deduct costs
                userAccount.coins -= shopItems.playerIDChangeCost;
                userAccount.balance -= newIdCost;
                currentUserCoins = userAccount.coins;
                currentUserBalance = userAccount.balance;

                // Update player's ID and type
                playerToUpdate.id = newPlayerId;
                playerToUpdate.idType = newIdType;

                // Mark new special ID as used
                if (newIdType !== 'normal') {
                    usedSpecialIds.add(newPlayerId);
                }

                saveState();
                updateBalanceDisplay();
                showModal('ID Change Successful', `Player "${playerToUpdate.name}"'s ID has been changed to "${newPlayerId}"! Cost: ${shopItems.playerIDChangeCost} ðŸª™${newIdCost > 0 ? ` and ${newIdCost.toLocaleString()} â‚®` : ''}.`);
                renderShop(); // Re-render shop to update available IDs
                activateTab('players'); // Go to player list to see the change
            });
        };


        // --- Main Render Logic ---
        const renderContent = (tab) => {
            const user = userAccounts.find(acc => acc.id === loggedInUserId);
            document.getElementById('loggedInUserIdDisplay').textContent = user ? user.id.toUpperCase() : 'Not Logged In';
            updateBalanceDisplay(); // Always update balance display

            // If not logged in and trying to access a restricted tab, redirect to login
            if (!loggedInUserId && tab !== 'registerPlayer') {
                renderLogin();
                return;
            }

            switch (tab) {
                case 'registerPlayer':
                    // If logged in and not admin, deny access.
                    // If not logged in, or if admin, allow.
                    if (loggedInUserId && !isCurrentUserAdmin) {
                        showModal('Access Denied', 'Only administrators can register new players.');
                        activateTab('players'); // Redirect to players list
                    } else {
                        renderRegisterPlayer();
                    }
                    break;
                case 'players':
                    renderPlayerList();
                    break;
                case 'requests':
                    renderDuelRequests();
                    break;
                case 'duels':
                    renderActiveDuels();
                    break;
                case 'shop':
                    renderShop();
                    break;
                default:
                    // If logged in, default to players. If not, default to login.
                    if (loggedInUserId) {
                        renderPlayerList();
                    } else {
                        renderLogin();
                    }
            }
        };

        // --- Modal Close Button Listener ---
        document.getElementById('modalCloseBtn').addEventListener('click', hideModal);
        document.getElementById('modalOverlay').addEventListener('click', (e) => {
            if (e.target.id === 'modalOverlay') {
                hideModal();
            }
        });

        // Initial render on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Check if user is already logged in from previous session
            if (loggedInUserId) {
                const user = userAccounts.find(acc => acc.id === loggedInUserId);
                if (user) {
                    currentUserBalance = user.balance;
                    currentUserCoins = user.coins;
                    isCurrentUserAdmin = user.isAdmin || false;
                    renderMainAppContent();
                } else {
                    // Logged in user ID found, but account not found (e.g., localStorage cleared partially)
                    loggedInUserId = null;
                    saveState();
                    renderLogin();
                }
            } else {
                renderLogin(); // Start with login if not logged in
            }
        });
    </script>
</body>
</html>
